#!/usr/bin/env perl
# Emacs: -*- mode: cperl; -*-
# For license: see LICENSE file at top-level

use strict;
use warnings;
use diagnostics;

use File::Basename;
my $progname = basename($ARGV[0]);

my $launcher = '';

if (defined $ENV{SHMEM_LAUNCHER}) {
  $launcher = $ENV{SHMEM_LAUNCHER};
}

if ($launcher eq '') {
  $launcher = '@SHMEM_LAUNCHER@';
}

if ($launcher eq '') {
  $launcher = 'prun';
}

my $pid = open my $pipe, '-|', 'prte';

if (! defined $pid) {
  print STDERR "$progname: failed to run PRTE\n";
  exit 1;
}

if ($pid) {			# parent
  # print "Parent has child PID $pid\n";

  my $ok = 0;
  while (<$pipe>) {
    if (/^DVM ready/) {
      $ok = 1;
      last;
    }
  }

  if ($ok) {
    # print "Parent got start-up from child\n";

    system $launcher, @ARGV;
  }

  # print "Parent reaps child PID $pid\n";
  kill TERM => $pid;
  waitpid($pid,0);
}
